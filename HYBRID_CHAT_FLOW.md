# ğŸ”„ Hybrid Chat Flow Diagram

## System Architecture Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         USER QUESTION                            â”‚
â”‚              "Is my security deposit amount legal?"              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    QUESTION CLASSIFIER                           â”‚
â”‚                 (lib/perplexity-chat.ts)                        â”‚
â”‚                                                                  â”‚
â”‚  1. shouldUsePerplexity(question)                               â”‚
â”‚     â†’ Checks for "legal", "rights", "what is", etc.            â”‚
â”‚                                                                  â”‚
â”‚  2. shouldUseBothSources(question)                              â”‚
â”‚     â†’ Checks for "is this legal", "compare", etc.              â”‚
â”‚                                                                  â”‚
â”‚  Result: { usePerplexity: false, useBoth: true }               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â†“                                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   LEASE RAG SEARCH   â”‚          â”‚  PERPLEXITY SEARCH   â”‚
â”‚  (useBoth = true)    â”‚          â”‚  (useBoth = true)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“                                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Fetch Lease Data    â”‚          â”‚  Build Search Query  â”‚
â”‚  from Supabase       â”‚          â”‚  + Context           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“                                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Rebuild RAG with    â”‚          â”‚  Call Perplexity API â”‚
â”‚  Embeddings          â”‚          â”‚  (Sonar model)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“                                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Search: "security   â”‚          â”‚  Search: "security   â”‚
â”‚  deposit"            â”‚          â”‚  deposit legal limit"â”‚
â”‚  â†’ retrieve(q, 5)    â”‚          â”‚  â†’ web_search        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“                                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Found 3 chunks:     â”‚          â”‚  Found 2 citations:  â”‚
â”‚  â€¢ Page 2: "$2,400"  â”‚          â”‚  â€¢ law.justia.com    â”‚
â”‚  â€¢ Page 2: "2x rent" â”‚          â”‚  â€¢ nolo.com          â”‚
â”‚  â€¢ Page 8: "return"  â”‚          â”‚                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“                                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Create Lease        â”‚          â”‚  Create Web Sources: â”‚
â”‚  Sources:            â”‚          â”‚  {                   â”‚
â”‚  {                   â”‚          â”‚    type: 'web',      â”‚
â”‚    type: 'lease',    â”‚          â”‚    url: '...',       â”‚
â”‚    pageNumber: 2,    â”‚          â”‚    title: 'Source 1' â”‚
â”‚    text: '...'       â”‚          â”‚  }                   â”‚
â”‚  }                   â”‚          â”‚                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      GPT-4 SYNTHESIS                             â”‚
â”‚                  (Hybrid Mode Prompt)                            â”‚
â”‚                                                                  â”‚
â”‚  System: "You combine lease + general knowledge..."             â”‚
â”‚                                                                  â”‚
â”‚  User:                                                           â”‚
â”‚    "INFORMATION FROM YOUR LEASE:                                â”‚
â”‚     [Page 2]: Your deposit is $2,400...                         â”‚
â”‚                                                                  â”‚
â”‚     GENERAL INFORMATION:                                         â”‚
â”‚     California limits deposits to 2x monthly rent..."           â”‚
â”‚                                                                  â”‚
â”‚  GPT-4o Response:                                               â”‚
â”‚    "According to your lease (Page 2), your security deposit     â”‚
â”‚     is $2,400. In general, California law limits deposits to    â”‚
â”‚     2x monthly rent for unfurnished units. If your monthly      â”‚
â”‚     rent is $1,200, then your $2,400 deposit is at the legal   â”‚
â”‚     maximum allowed."                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      BUILD RESPONSE                              â”‚
â”‚                                                                  â”‚
â”‚  {                                                               â”‚
â”‚    answer: "According to your lease...",                        â”‚
â”‚    sources: [                                                    â”‚
â”‚      { type: 'lease', pageNumber: 2, text: '...' },            â”‚
â”‚      { type: 'web', url: 'https://...', title: '...' }         â”‚
â”‚    ],                                                            â”‚
â”‚    timestamp: "2025-11-12T...",                                 â”‚
â”‚    usedPerplexity: true                                         â”‚
â”‚  }                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SAVE TO DATABASE                              â”‚
â”‚         (chat_history table in Supabase)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    RETURN TO FRONTEND                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      UI RENDERING                                â”‚
â”‚                  (components/LeaseChat.tsx)                     â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ ğŸ’¬ Assistant                                         â”‚       â”‚
â”‚  â”‚                                                      â”‚       â”‚
â”‚  â”‚ According to your lease (Page 2), your security     â”‚       â”‚
â”‚  â”‚ deposit is $2,400. In general, California law       â”‚       â”‚
â”‚  â”‚ limits deposits to 2x monthly rent for unfurnished  â”‚       â”‚
â”‚  â”‚ units. If your monthly rent is $1,200, then your    â”‚       â”‚
â”‚  â”‚ $2,400 deposit is at the legal maximum allowed.     â”‚       â”‚
â”‚  â”‚                                                      â”‚       â”‚
â”‚  â”‚ ğŸŸ£ From Your Lease:                                 â”‚       â”‚
â”‚  â”‚    [Page 2] [Page 8]                                â”‚       â”‚
â”‚  â”‚                                                      â”‚       â”‚
â”‚  â”‚ ğŸ”µ From Web Search:                                 â”‚       â”‚
â”‚  â”‚    [Source 1 ğŸ”—] [Source 2 ğŸ”—]                      â”‚       â”‚
â”‚  â”‚                                                      â”‚       â”‚
â”‚  â”‚ 3:45 PM                                             â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Decision Tree

```
                        START
                          |
                    [User Question]
                          |
                          â†“
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ Contains lease        â”‚
              â”‚ keywords?             â”‚
              â”‚ (my lease, page X)    â”‚
              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“       â†“
                   YES      NO
                     â†“       â†“
              â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”   â”‚
              â”‚ LEASE    â”‚   â”‚
              â”‚ RAG ONLY â”‚   â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                             â†“
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ Contains external    â”‚
              â”‚ keywords?            â”‚
              â”‚ (what is, rights)    â”‚
              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“       â†“
                   YES      NO
                     â†“       â†“
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”   â”‚
       â”‚ Contains hybrid â”‚   â”‚
       â”‚ keywords?       â”‚   â”‚
       â”‚ (is this legal) â”‚   â”‚
       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜   â”‚
              â†“      â†“       â†“
            YES     NO    LEASE
              â†“      â†“    RAG ONLY
          â”Œâ”€â”€â”€â”´â”€â”€â”  â”‚    (default)
          â”‚ BOTH â”‚  â”‚
          â”‚      â”‚  â”‚
          â””â”€â”€â”€â”€â”€â”€â”˜  â”‚
                    â†“
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚PERPLEXITYâ”‚
              â”‚   ONLY   â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Source Attribution Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     RESPONSE SOURCES                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             |
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â†“                              â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  LEASE SOURCES  â”‚          â”‚  WEB SOURCES    â”‚
    â”‚  (type: 'lease')â”‚          â”‚  (type: 'web')  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“                             â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Has pageNumber  â”‚          â”‚ Has url + title â”‚
    â”‚ Has text        â”‚          â”‚ Has text        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“                             â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ UI: Purple dot  â”‚          â”‚ UI: Blue dot    â”‚
    â”‚ "From Your      â”‚          â”‚ "From Web       â”‚
    â”‚  Lease:"        â”‚          â”‚  Search:"       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“                             â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Clickable badge â”‚          â”‚ External link   â”‚
    â”‚ Opens PDF to    â”‚          â”‚ Opens source    â”‚
    â”‚ specific page   â”‚          â”‚ in new tab      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Three Modes Comparison

### Mode 1: Lease RAG Only
```
Question: "What does my lease say about pets?"
    â†“
Detects: "my lease" keyword
    â†“
Action: Search lease RAG (5 chunks)
    â†“
Prompt: "ONLY use lease excerpts"
    â†“
Result: "According to your lease (Page 5)..."
    â†“
Sources: ğŸŸ£ Page 5, Page 6
```

### Mode 2: Perplexity Only
```
Question: "What are tenant rights in California?"
    â†“
Detects: "tenant rights" + "what are"
    â†“
Action: Perplexity web search
    â†“
Prompt: "General information, suggest checking lease"
    â†“
Result: "In California, tenants have the right to..."
    â†“
Sources: ğŸ”µ Source 1, Source 2
```

### Mode 3: Hybrid (Both)
```
Question: "Is my security deposit amount legal?"
    â†“
Detects: "is this legal" pattern
    â†“
Action: BOTH lease RAG + Perplexity
    â†“
Prompt: "Combine both, clearly distinguish sources"
    â†“
Result: "Your lease says... (Page 2). In general, law says..."
    â†“
Sources: ğŸŸ£ Page 2 + ğŸ”µ Source 1, Source 2
```

---

## Error Handling Flow

```
                    [API Request]
                         |
                         â†“
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ Fetch Lease    â”‚
                â”‚ Data           â”‚
                â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
                    â†“        â†“
                 Success   Error
                    â†“        â†“
                    |    Return 404
                    â†“
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ Try Perplexity â”‚
            â”‚ (if needed)    â”‚
            â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
                â†“        â†“
             Success   Fail
                â†“        â†“
                |    Log error
                |    Continue
                |    with lease
                â†“    only
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Generate with â”‚
        â”‚ GPT-4         â”‚
        â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
            â†“       â†“
         Success  Error
            â†“       â†“
            |   Return 500
            â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Save History  â”‚
    â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
    [Return 200]
```

---

## Data Flow Example

### Input:
```json
{
  "leaseDataId": "abc-123",
  "userEmail": "user@example.com",
  "question": "Is my rent increase legal?",
  "chatHistory": []
}
```

### Processing:
```javascript
// Step 1: Classification
shouldUsePerplexity("Is my rent increase legal?")
// â†’ true (has "is", "legal")

shouldUseBothSources("Is my rent increase legal?")
// â†’ true (has "is this legal" pattern)

// Step 2: Lease RAG
rag.retrieve("rent increase", 5)
// â†’ [
//     { text: "Rent may increase...", pageNumber: 4 },
//     { text: "Notice required...", pageNumber: 4 },
//   ]

// Step 3: Perplexity
searchWithPerplexity("Is my rent increase legal?", {
  leaseLocation: "123 Main St, Los Angeles, CA"
})
// â†’ {
//     answer: "California law limits rent increases...",
//     citations: ["https://law.justia.com/...", "https://nolo.com/..."]
//   }

// Step 4: GPT-4 Synthesis
openai.chat.completions.create({
  messages: [
    { role: 'system', content: 'Hybrid mode prompt...' },
    { role: 'user', content: 'LEASE: ... WEB: ...' }
  ]
})
// â†’ "According to your lease (Page 4), rent increases..."
```

### Output:
```json
{
  "answer": "According to your lease (Page 4)...",
  "sources": [
    {
      "type": "lease",
      "text": "Rent may increase...",
      "pageNumber": 4
    },
    {
      "type": "web",
      "text": "California law limits...",
      "url": "https://law.justia.com/...",
      "title": "Web Source 1"
    }
  ],
  "timestamp": "2025-11-12T15:45:00Z",
  "usedPerplexity": true
}
```

---

## Performance Timeline

```
0ms    â”‚ Request received
       â”‚
50ms   â”‚ â”œâ”€ Fetch lease data from Supabase
       â”‚
100ms  â”‚ â”œâ”€ Rebuild RAG from chunks
       â”‚
       â”‚ â”Œâ”€â”€â”€â”€â”€â”€ PARALLEL â”€â”€â”€â”€â”€â”€â”
       â”‚ â”‚                       â”‚
500ms  â”‚ â”œâ”€ RAG search (5)      â”œâ”€ Perplexity search
       â”‚ â”‚                       â”‚
1500ms â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚             â”‚
       â”‚             â†“
       â”‚ â”œâ”€ Combine results
       â”‚
2000ms â”‚ â”œâ”€ GPT-4 synthesis
       â”‚
4000ms â”‚ â”œâ”€ Response generated
       â”‚
4100ms â”‚ â”œâ”€ Save to database
       â”‚
4200ms â”‚ â””â”€ Return to client
```

**Total: ~4-6 seconds for hybrid mode**

---

## Summary

The hybrid chat system:
- âœ… **Intelligently routes** questions based on content
- âœ… **Searches multiple sources** when beneficial
- âœ… **Clearly attributes** all information
- âœ… **Handles errors gracefully** with fallbacks
- âœ… **Provides comprehensive** answers combining lease + general knowledge

**Result**: Users get the most relevant information from the right sources! ğŸ¯

